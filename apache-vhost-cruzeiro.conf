# Virtual Host para Escolas do Cruzeiro com ModSecurity
# Arquivo: /etc/apache2/sites-available/cruzeiro.conf

<VirtualHost *:80>
    ServerName localhost:8000
    DocumentRoot /var/www/html
    
    # Redirecionar para HTTPS
    RewriteEngine On
    RewriteCond %{HTTPS} off
    RewriteRule ^(.*)$ https://%{HTTP_HOST}%{REQUEST_URI} [L,R=301]
</VirtualHost>

<VirtualHost *:443>
    ServerName localhost:8000
    DocumentRoot /var/www/html
    
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile /etc/letsencrypt/live/localhost:8000/fullchain.pem
    SSLCertificateKeyFile /etc/letsencrypt/live/localhost:8000/privkey.pem
    
    # ModSecurity Configuration
    SecRuleEngine On
    SecRequestBodyAccess On
    SecResponseBodyAccess Off
    SecRequestBodyLimit 13107200
    SecRequestBodyNoFilesLimit 131072
    
    # Headers de Segurança
    Header always set X-Content-Type-Options nosniff
    Header always set X-Frame-Options DENY
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains"
    Header always set Referrer-Policy "strict-origin-when-cross-origin"
    
    # PHP Configuration
    DirectoryIndex index.php index.html
    
    # Diretório principal
    <Directory /var/www/html>
        AllowOverride All
        Require all granted
        
        # ModSecurity específico para frontend
        SecRuleEngine On
    </Directory>
    
    # Proteção extra para área administrativa
    <Directory /var/www/html/Backend/admin>
        # Autenticação adicional se necessário
        # AuthType Basic
        # AuthName "Admin Area"
        # AuthUserFile /etc/apache2/.htpasswd
        # Require valid-user
        
        # ModSecurity mais rigoroso para admin
        SecRuleEngine On
        SecRequestBodyAccess On
    </Directory>
    
    # Proteger arquivos JSON
    <Directory /var/www/html/Backend/data>
        <Files "*.json">
            # Apenas scripts PHP podem acessar
            <RequireAll>
                Require local
                Require ip 127.0.0.1
            </RequireAll>
        </Files>
    </Directory>
    
    # Logs específicos
    ErrorLog ${APACHE_LOG_DIR}/cruzeiro_error.log
    CustomLog ${APACHE_LOG_DIR}/cruzeiro_access.log combined
    
    # Log do ModSecurity
    SecAuditEngine RelevantOnly
    SecAuditLog ${APACHE_LOG_DIR}/cruzeiro_modsec_audit.log
</VirtualHost>