# OWASP ModSecurity Core Rule Set (CRS) Configuration
# Configuração para Escolas do Cruzeiro

# Configurações básicas
SecRuleEngine On
SecRequestBodyAccess On
SecRule REQUEST_HEADERS:Content-Type "text/xml" \
     "id:'200000',phase:1,t:none,t:lowercase,pass,nolog,ctl:requestBodyProcessor=XML"

# Configurações de limite
SecRequestBodyLimit 13107200
SecRequestBodyNoFilesLimit 131072
SecRequestBodyInMemoryLimit 131072
SecRequestBodyLimitAction Reject

# Configurações de resposta
SecResponseBodyAccess Off
SecResponseBodyMimeType text/plain text/html text/xml
SecResponseBodyLimit 524288
SecResponseBodyLimitAction ProcessPartial

# Configurações de arquivo temporário
SecTmpDir /tmp/
SecDataDir /tmp/

# Configurações de auditoria
SecAuditEngine RelevantOnly
SecAuditLogRelevantStatus "^(?:5|4(?!04))"
SecAuditLogParts ABIJDEFHZ
SecAuditLogType Serial
SecAuditLog /var/log/apache2/modsec_audit.log

# Configurações de debug (desabilitado em produção)
SecDebugLog /var/log/apache2/modsec_debug.log
SecDebugLogLevel 0

# Configurações específicas para aplicação PHP
SecRule MULTIPART_STRICT_ERROR "!@eq 0" \
"id:'200002', phase:2,t:none,log,deny,status:44,msg:'Multipart request body failed strict validation: \
PE %{REQBODY_PROCESSOR_ERROR}, \
BQ %{MULTIPART_BOUNDARY_QUOTED}, \
BW %{MULTIPART_BOUNDARY_WHITESPACE}, \
DB %{MULTIPART_DATA_BEFORE}, \
DA %{MULTIPART_DATA_AFTER}, \
HF %{MULTIPART_HEADER_FOLDING}, \
LF %{MULTIPART_LF_LINE}, \
SM %{MULTIPART_MISSING_SEMICOLON}, \
IQ %{MULTIPART_INVALID_QUOTING}, \
IP %{MULTIPART_INVALID_PART}, \
IH %{MULTIPART_INVALID_HEADER_FOLDING}, \
FL %{MULTIPART_FILE_LIMIT_EXCEEDED}'"

# Configurações de encoding
SecRule REQBODY_ERROR "!@eq 0" \
"id:'200003',phase:2,t:none,log,deny,status:400,msg:'Failed to parse request body.',logdata:'Error %{reqbody_error_msg}',severity:2"

# Configurações de argumentos
SecArgumentSeparator &
SecCookieFormat 0

# Configurações de coleta de dados
SecCollectionTimeout 600
SecHttpBlKey whdkfieyhtnf

# Configurações específicas para Cruzeiro
# Permitir uploads de imagens para notícias
SecRule FILES_TMPNAMES "@detectSQLi" \
    "id:'200010',phase:2,block,msg:'SQL Injection Attack Detected in File Upload',logdata:'Matched Data: %{MATCHED_VAR} found within %{MATCHED_VAR_NAME}',severity:2,tag:'application-multi',tag:'language-multi',tag:'platform-multi',tag:'attack-sqli'"

# Configurações de rate limiting para admin
SecAction "id:'200020',phase:1,nolog,pass,initcol:ip=%{REMOTE_ADDR},initcol:user=%{REMOTE_ADDR},setvar:ip.requests_per_min=+1,deprecatevar:ip.requests_per_min=1/60"
SecRule IP:REQUESTS_PER_MIN "@gt 60" \
    "id:'200021',phase:1,deny,status:429,msg:'Rate limit exceeded',logdata:'Current rate: %{ip.requests_per_min} requests per minute'"